#include <tunables/global>

profile cloudflare-ddns flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>

  # Capabilities
  capability net_raw,
  capability net_admin,

  # S6-Overlay - ensure /init can be read and executed
  /init rix,
  /bin/** ix,
  /usr/bin/** ix,
  /run/{s6,s6-rc*,service}/** ix,
  /package/** ix,
  /command/** ix,
  /etc/services.d/** rwix,
  /etc/cont-init.d/** rwix,
  /etc/cont-finish.d/** rwix,
  /run/{,**} rwk,
  /dev/tty rw,

  # Bashio
  /usr/lib/bashio/** ix,
  /tmp/** rwk,

  # Access to options.json and other files within your addon
  /data/** rw,

  # Allow shell to read files
  /bin/bash rix,
  /bin/sh rix,

  # Start new profile for service
  /usr/local/bin/ddns cx -> ddns,

  profile ddns flags=(attach_disconnected,mediate_deleted) {
    #include <abstractions/base>

    # Receive signals from S6-Overlay
    signal (receive) peer=*_cloudflare-ddns,

    # Access to DNS and networking
    capability net_raw,
    capability net_admin,
    network inet stream,
    network inet6 stream,
    network inet dgram,
    network inet6 dgram,

    # Allow the binary to execute
    /usr/local/bin/ddns mr,

    # Access to configuration
    /data/** r,

    # System access for IP detection
    /proc/sys/net/** r,
    /sys/class/net/** r,
    /etc/hosts r,
    /etc/resolv.conf r,
    /etc/nsswitch.conf r,
    /etc/ssl/certs/** r,
    /etc/ssl/openssl.cnf r,

    # Deny access to sensitive data
    deny /data/options.json w,
  }
}
